<!DOCTYPE html>{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Gardens</title>
    <!-- favicons Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/images/favicons/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'assets/images/favicons/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'assets/images/favicons/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'assets/images/favicons/site.webmanifest' %}">
    <meta name="description"
        content="Grdeen is a modern HTML Template for Garden care, Spring cleaning, Lawn care, Garden Design, Planting, Garden maintenance and Lawn care & mowing
    .The template perfectly fits Garden care, Spring cleaning, Lawn care and Wellness Treatments websites and businesses.">

    <!-- fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="../css2?family=DM+Sans:wght@100;200;300;400;500;600;700;800;900;1000&display=swap" rel="stylesheet">
    <link href="../css2-1?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="../css2-2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'assets/vendors/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/bootstrap-select/bootstrap-select.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/animate/animate.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/fontawesome/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/jquery-ui/jquery-ui.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/jarallax/jarallax.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/jquery-magnific-popup/jquery.magnific-popup.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/nouislider/nouislider.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/nouislider/nouislider.pips.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/tiny-slider/tiny-slider.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/grdeen-icons/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/owl-carousel/css/owl.carousel.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/owl-carousel/css/owl.theme.default.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/vendors/grdeen-two-icons/style.css' %}">

    <!-- template styles -->
    <link rel="stylesheet" href="{% static 'assets/css/grdeen.css' %}">

    <!-- Notification System Styles -->
    <link rel="stylesheet" href="{% static 'assets/css/notifications.css' %}">

    <!-- User Menu Styles -->
    <link rel="stylesheet" href="{% static 'assets/css/user-menu.css' %}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .goog-logo-link,
        .goog-te-gadget span {
            display: none !important;
        }

        .goog-te-gadget {
            font-size: 0;
        }

        /* Consistent main menu colors - fix for home page menu color issue */
        .main-header--three .main-menu .main-menu__list>li>a,
        .main-menu .main-menu__list>li>a {
            color: var(--grdeen-white, #fff) !important;
            text-shadow: none !important;
        }

        /* Only show different color on actual hover or when truly current page */
        .main-header--three .main-menu .main-menu__list>li:hover>a,
        .main-menu .main-menu__list>li:hover>a {
            color: var(--grdeen-black, #172000) !important;
            text-shadow: 0 0 0.5px var(--grdeen-black, #172000) !important;
        }

        /* Remove current class styling from all menu items on home page */
        body .main-menu .main-menu__list>li.current>a {
            color: var(--grdeen-white, #fff) !important;
            text-shadow: none !important;
        }

        /* Only apply current styling when actually hovering */
        body .main-menu .main-menu__list>li.current:hover>a {
            color: var(--grdeen-black, #172000) !important;
            text-shadow: 0 0 0.5px var(--grdeen-black, #172000) !important;
        }

        /*Translation CSS*/
        /* Hide the outer container of the Google Translate toolbar */
        .goog-te-banner-frame.skiptranslate {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
        }

        #custom_translate_buttons {
            position: relative;
            z-index: 1000;
            padding: 10px 0;
            text-align: center;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        #custom_translate_buttons button {
            padding: 5px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 10px;
            font-family: var(--montserrat);
            background-color: #c69009;
            color: #000;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #custom_translate_buttons button:hover,
        #custom_translate_buttons button.active {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #custom_translate_buttons button.active {
            background-color: #2d7a32;
            color: #fff;
        }

        /* Adjust the body top margin */
        body {
            top: 0px !important;
        }
    </style>
</head>

<body class="custom-cursor">

    <div class="custom-cursor__cursor"></div>
    <div class="custom-cursor__cursor-two"></div>

    <div class="preloader">
        <div class="preloader__image" style="background-image: url('{% static 'assets/images/loader.png' %}')"></div>
    </div>
    <!-- /.preloader -->
    <div class="page-wrapper">
        <div class="topbar-one topbar-one--three">
            <div class="container-fluid">
                <div class="topbar-one__inner">
                    <ul class="list-unstyled topbar-one__info">
                        <li class="topbar-one__info__item">
                            <div class="topbar-one__info__iconwrap">
                                <i class="icon-pin"></i>
                            </div>
                            <a href="{% url 'contact' %}">{{info.address}}</a>
                        </li>
                        <li class="topbar-one__info__item">
                            <div class="topbar-one__info__iconwrap">
                                <i class="icon-email"></i>
                            </div>
                            <a href="mailto:{{info.contact_email}}">{{info.contact_email}}</a>
                        </li>
                    </ul><!-- /.list-unstyled topbar-one__info -->
                    <div class="topbar-one__right">
                        {% if user.is_authenticated %}
                        <div class="user-menu-dropdown dropdown">
                            <a href="" class="grdeen-btn main-header__btn dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <i class="fas fa-user me-2"></i>
                                <span>{{ user.email|default:user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'logout' %}"><i
                                            class="fas fa-sign-out-alt me-2"></i>{% trans "Logout" %}</a></li>
                            </ul>
                        </div>
                        {% else %}
                        <a href="{% url 'login' %}" class="grdeen-btn main-header__btn">
                            <span>{% trans "Login" %}</span>
                        </a><!-- /.thm-btn main-header__btn -->
                        {% endif %}
                        <div class="topbar-one__right__openitme d-flex align-items-center">
                            <div class="topbar-one__right__iconwrap">
                                <i class="fas fa-phone-square-alt"></i>
                            </div>
                            <p class="topbar-one__text">{% trans "Working hours" %}: {{ info.opening_hours }}</p><!-- /.topbar-one__text -->
                        </div>
                        <ul class="list-unstyled topbar-one__right__list">
                            <li><a href="{% url 'contact' %}">{% trans "Help" %}</a></li>
                            <li><a href="{% url 'team' %}">{% trans "Career" %}</a></li>
                            <li><a href="{% url 'about' %}">{% trans "Office" %}</a></li>
                        </ul>

                        <!-- Custom Translate Buttons -->
                        <div id="custom_translate_buttons">
                            <form action="{% url 'set_language' %}" method="post" id="lang-form" style="display: none;">
                                {% csrf_token %}
                                <input type="hidden" name="language" id="lang-input">
                                <input type="hidden" name="next" value="{{ request.path }}">
                            </form>
                            <button class="notranslate {% if LANGUAGE_CODE == 'uz' %}active{% endif %}" onclick="setLang('uz')">O'zbekcha</button>
                            <button class="notranslate {% if LANGUAGE_CODE == 'en' %}active{% endif %}" onclick="setLang('en')">English</button>
                            <button class="notranslate {% if LANGUAGE_CODE == 'ru' %}active{% endif %}" onclick="setLang('ru')">–†—É—Å—Å–∫–∏–π</button>
                        </div>
                        <div class="topbar-one__social">
                            {% for social in social_links %}
                            <a href="{{ social.url }}" target="_blank">{{ social.icon|safe }}
                                <span class="sr-only">{{ social.platform }}</span>
                            </a>
                            {% endfor %}
                        </div><!-- /.topbar-one__social -->
                    </div><!-- /.topbar-one__right -->
                </div><!-- /.topbar-one__inner -->
            </div><!-- /.container-fluid -->
        </div><!-- /.topbar-one -->

        <header class="main-header main-header--three sticky-header sticky-header--normal">
            <div class="container-fluid">
                <div class="main-header__inner">

                    <div class="main-header__logo">
                        <a href="{% url 'home' %}">
                            <img src="{% static 'assets/images/logo-dark.png' %}" alt="Grdeen HTML">
                        </a>
                    </div><!-- /.main-header__logo -->

                    <nav class="main-header__nav main-menu">
                        <ul class="main-menu__list">
                            <li {% if request.resolver_match.url_name == 'services' or request.resolver_match.url_name == 'service_details' %}class="current" {% endif %}>
                                <a href="#">{% trans "Services" %}</a>
                                <ul>
                                    {% for service in ourservices %}
                                    <li><a href="{% url 'service_details' service.slug %}">{{ service.title }}</a>
                                    {% if service.category.all %}
                                    <ul>
                                        {% for category in service.category.all %}
                                        <li>
                                            <a href="{% url 'service_details' category.slug %}">{{ category.name }}</a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    </li>
                                    {% endfor %}
                                   
                                </ul>
                            </li>
                            <li {% if request.resolver_match.url_name == 'about' %}class="current" {% endif %}>
                                <a href="{% url 'about' %}">{% trans "About Us" %}</a>
                            </li>
                            <li {% if request.resolver_match.url_name == 'projects' or request.resolver_match.url_name == 'project_details' %}class="current" {% endif %}>
                                <a href="{% url 'projects' %}">{% trans "Projects" %}</a>
                            </li>
                            <li
                                class="dropdown {% if request.resolver_match.url_name == 'team' or request.resolver_match.url_name == 'team_details' or request.resolver_match.url_name == 'faq' %}current{% endif %}">
                                <a href="#" style="pointer-events: none;">{% trans "Pages" %}</a>
                                <ul>
                                    <li><a href="{% url 'team' %}">{% trans "Team" %}</a></li>
                                    <li><a href="{% url 'faq' %}">FAQs</a></li>
                                </ul>
                            </li>
                            {% if user.is_staff %}
                            <li 
                            
                                class="dropdown {% if request.resolver_match.url_name == 'products' or request.resolver_match.url_name == 'product_details' or request.resolver_match.url_name == 'cart' or request.resolver_match.url_name == 'my_likes' or request.resolver_match.url_name == 'checkout' %}current{% endif %}">
                                <a href="#" style="pointer-events: none;">{% trans "Shop" %}</a>
                                <ul class="sub-menu">
                                    <li class="dropdown">
                                        <a href="{% url 'products' %}">{% trans "Products" %}</a>
                                    </li>
                                    <li><a href="{% url 'cart' %}">{% trans "Cart" %}</a></li>
                                    <li><a href="{% url 'my_likes' %}">{% trans "My Likes" %}</a></li>
                                    <li><a href="{% url 'checkout' %}">{% trans "Checkout" %}</a></li>
                                </ul>
                            </li>
                            {% endif %}
                            <li {% if request.resolver_match.url_name == 'blog' or request.resolver_match.url_name == 'blog_details' %}class="current" {% endif %}>
                                <a href="{% url 'blog' %}">{% trans "Blog" %}</a>

                            </li>
                            <li {% if request.resolver_match.url_name == 'contact' %}class="current" {% endif %}>
                                <a href="{% url 'contact' %}">{% trans "Contact" %}</a>
                            </li>
                        </ul>
                    </nav><!-- /.main-header__nav -->
                    <div class="main-header__right">
                        <div class="mobile-nav__btn mobile-nav__toggler">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div><!-- /.mobile-nav__toggler -->

                        <a href="" class="search-toggler main-header__search">
                            <div class="main-header__search__icon">
                                <i class="icon-search" aria-hidden="true"></i>
                            </div>
                            <span class="sr-only">Search</span>
                        </a><!-- /.search-toggler -->
                        {% if user.is_staff %}
                        <a href="{% url 'cart' %}" class="main-header__cart">
                            <div class="main-header__cart__icon">
                                <i class="icon-shop-bag" aria-hidden="true"></i>
                            </div>
                            <span class="main-header__cart__count" id="cart_count">{{ cart_item_count }}</span>
                            <span class="sr-only">cart</span>
                        </a><!-- /.cart-toggler -->
                        <a href="{% url 'my_likes' %}" class="main-header__cart">
                            <div class="main-header__cart__icon">
                                <i class="fas fa-heart" aria-hidden="true"></i>
                            </div>
                            <span class="main-header__likes__count" id="likes_count">{{ likes_count }}</span>
                            <span class="sr-only">likes</span>
                        </a><!-- /.likes-toggler -->
                        {% endif %}
                        <div class="main-header__helpline">
                            <div class="main-header__helpline__bg"
                                style="background-image: url('{% static 'assets/images/shapes/nav-phone-icon3-1.png' %}')">
                            </div>
                            <div class="main-header__helpline__icon">
                                <i class="icon-phone-receiver-silhouette"></i>
                            </div>
                            <div class="main-header__helpline__phonewrap">
                                <p class="main-header__helpline__text">{% trans "Contact us" %}</p>
                                <a class="main-header__helpline__tel" href="tel:{{ info.phone_number }}">{{ info.phone_number }}</a>
                            </div>
                        </div>
                    </div><!-- /.main-header__right -->
                </div><!-- /.main-header__inner -->
            </div><!-- /.container-fluid -->
        </header><!-- /.main-header -->

        <!-- Notification Container -->
        <div class="notification-container" id="notification-container">
            {% if messages %}
            {% for message in messages %}
            <div class="notification notification-{{ message.tags }}" data-auto-dismiss="5000">
                <div class="notification-icon">
                    {% if message.tags == 'success' %}
                    <i class="fas fa-check-circle"></i>
                    {% elif message.tags == 'error' %}
                    <i class="fas fa-times-circle"></i>
                    {% elif message.tags == 'warning' %}
                    <i class="fas fa-exclamation-triangle"></i>
                    {% elif message.tags == 'info' %}
                    <i class="fas fa-info-circle"></i>
                    {% else %}
                    <i class="fas fa-bell"></i>
                    {% endif %}
                </div>
                <div class="notification-content">
                    {{ message }}
                </div>
                <button class="notification-close" onclick="dismissNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            {% endfor %}
            {% endif %}
        </div>

        {% block content %}
        {% endblock %}
        <footer class="main-footer main-footer--two">
            <div class="main-footer__bg"
                style="background-image: url({% static 'assets/images/backgrounds/footer-bg1-1.jpg' %})"></div>
            <div class="main-footer__overlay"></div>
            <!-- /.main-footer__bg -->
            <div class="main-footer__top">
                <div class="container">
                    <div class="row">
                        <div class="footer-widget__col footer-widget__col__col1">
                            <div class="footer-widget footer-widget--about">
                                <a href="index.html" class="footer-widget__logo">
                                    <img src="{% static 'assets/images/logo-light.png' %}" width="155"
                                        alt="Agrofa HTML Template">
                                </a>
                                <p class="footer-widget__experience-text">{{ info.description }}</p>

                            </div><!-- /.footer-widget -->
                        </div><!-- /.col-md-6 -->

                        <div class="footer-widget__col  footer-widget__col__col2">
                            <div class="footer-widget footer-widget--links">
                                <h6 class="footer-widget__title">Havolalar</h6>
                                <ul class="list-unstyled footer-widget__links">
                                    <li><a href="{% url 'services' %}">Xizmatlar</a></li>
                                    <li><a href="{% url 'products' %}">Mahsulotlar</a></li>
                                    <li><a href="{% url 'projects' %}">Loyihalar</a></li>
                                    <li><a href="{% url 'about' %}">Biz haqimizda</a></li>
                                    <li><a href="{% url 'contact' %}">Kontakt</a></li>
                                </ul><!-- /.list-unstyled footer-widget__links -->
                            </div><!-- /.footer-widget -->
                        </div><!-- /.col-md-6 -->
                        <div class="footer-widget__col  footer-widget__col__col3">
                            <div class="footer-widget footer-widget--gallery">
                                <h6 class="footer-widget__title">Galereya</h6><!-- /.footer-widget__title -->
                                <div class="footer-widget__gallerywrap d-flex flex-wrap">
                                    <div class="footer-widget__gallerywrap__img">
                                        <img src="{% static 'assets/images/resources/footer-gallery1-1.jpg' %}" alt="">
                                    </div>
                                    <div class="footer-widget__gallerywrap__img">
                                        <img src="{% static 'assets/images/resources/footer-post1-4.jpg' %}" alt=""style="height: 102px !important;">
                                    </div>
                                    <div class="footer-widget__gallerywrap__img">
                                        <img src="{% static 'assets/images/resources/footer-post1-2.jpg' %}" alt=""style="height: 102px !important;">
                                    </div>
                                    <div class="footer-widget__gallerywrap__img">
                                        <img src="{% static 'assets/images/resources/footer-gallery1-4.jpg' %}" alt="">
                                    </div>
                                    <div class="footer-widget__gallerywrap__img">
                                        <img src="{% static 'assets/images/resources/footer-gallery1-5.jpg' %}" alt="">
                                    </div>
                                    <div class="footer-widget__gallerywrap__img">
                                        <img src="{% static 'assets/images/resources/footer-gallery1-6.jpg' %}" alt="">
                                    </div>
                                </div>
                            </div><!-- /.footer-widget -->
                        </div><!-- /.col-md-6 -->
                        <div class="footer-widget__col  footer-widget__col__col4">
                            <div class="footer-widget footer-widget--blog">
                                <h5 class="footer-widget__title">Mashhur Postlar</h5><!-- /.footer-widget__title -->

                                <div class="footer-widget__post-wrap">
                                    {% for post in populars|slice:":2" %}
                                    <div class="footer-widget__post-col">
                                        <div class="footer-widget__post-img">
                                            <img src="{{ post.image.url }}" alt="{{ post.minititle }}">
                                        </div>
                                        <div class="footer-widget__post-info">
                                            <span class="footer-widget__post-date"><i class="far fa-calendar"></i>
                                                <span> {{ post.publish_date|date:"d M Y" }}</span>
                                            </span>
                                            <h6 class="footer-widget__post-heading"><a href="">{{ post.minititle|truncatechars:50 }}</a></h6>
                                        </div>
                                    </div>
                                    {% endfor %}

                                </div>

                            </div><!-- /.footer-widget -->
                        </div><!-- /.col-md-6 -->
                    </div><!-- /.row -->
                </div><!-- /.container -->
            </div><!-- /.main-footer__top -->

            <div class="main-footer__bottom">
                <div class="container">
                    <div class="main-footer__bottom__inner">
                        <p class="main-footer__copyright"> &copy; <span class="dynamic-year"></span> {{ info.footer_text }}</p>
                        <div class="main-footer__social-row">
                            <p class="main-footer__social-row-text">Social</p>
                            <ul class="main-footer__social-list">
                                {% for social in social_links %}
                                <li><a href="{{ social.url }}" target="_blank">{{ social.icon|safe }}<span
                                            class="sr-only">{{ social.platform }}</span></a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div><!-- /.main-footer__inner -->
                </div><!-- /.container -->
            </div><!-- /.main-footer__bottom -->
        </footer><!-- /.main-footer -->

    </div><!-- /.page-wrapper -->

    <div class="mobile-nav__wrapper">
        <div class="mobile-nav__overlay mobile-nav__toggler"></div>
        <!-- /.mobile-nav__overlay -->
        <div class="mobile-nav__content">
            <span class="mobile-nav__close mobile-nav__toggler"><i class="fa fa-times"></i></span>

            <div class="logo-box">
                <a href="{% url 'home' %}" aria-label="logo image"><img
                        src="{% static 'assets/images/logo-light.png' %}" width="155" alt=""></a>
            </div>
            <!-- /.logo-box -->
            <div class="mobile-nav__container"></div>
            <!-- /.mobile-nav__container -->

            <ul class="mobile-nav__contact list-unstyled">
                <li>
                    <i class="fa fa-envelope"></i>
                    <a href="mailto:{{ info.contact_email }}">{{ info.contact_email }}</a>
                </li>
                <li>
                    <i class="fa fa-phone-alt"></i>
                    <a href="tel:{{ info.phone_number }}">{{ info.phone_number }}</a>
                </li>
            </ul><!-- /.mobile-nav__contact -->
            <div class="mobile-nav__social">
                {% for social in social_links %}
                <a href="{{ social.url }}" target="_blank">
                    {{ social.icon|safe }}
                    <span class="sr-only">{{ social.platform }}</span>
                </a>
                {% endfor %}

            </div><!-- /.mobile-nav__social -->
        </div>
        <!-- /.mobile-nav__content -->
    </div>
    <!-- /.mobile-nav__wrapper -->
    <div class="search-popup">
        <div class="search-popup__overlay search-toggler"></div>
        <!-- /.search-popup__overlay -->
        <div class="search-popup__content">
            <form role="search" method="get" class="search-popup__form" action="{% url 'search' %}">
                <input type="text" id="search" name="q" placeholder="mahsulotlar, xizmatlar bo'yicha qidirish..."
                    value="{{ request.GET.q }}">
                <button type="submit" aria-label="search submit" class="grdeen-btn">
                    <span><i class="icon-search"></i></span>
                </button>
            </form>
        </div>
        <!-- /.search-popup__content -->
    </div>
    <!-- /.search-popup -->

    <a href="#" data-target="html" class="scroll-to-target scroll-to-top">
        <span class="scroll-to-top__text">back top</span>
        <span class="scroll-to-top__wrapper"><span class="scroll-to-top__inner"></span></span>
    </a>

    <script src="{% static 'assets/vendors/jquery/jquery-3.7.0.min.js' %}"></script>
    <script src="{% static 'assets/vendors/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/vendors/bootstrap-select/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jarallax/jarallax.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-ui/jquery-ui.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-ajaxchimp/jquery.ajaxchimp.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-appear/jquery.appear.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-circle-progress/jquery.circle-progress.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-magnific-popup/jquery.magnific-popup.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-validate/jquery.validate.min.js' %}"></script>
    <script src="{% static 'assets/vendors/nouislider/nouislider.min.js' %}"></script>
    <script src="{% static 'assets/vendors/tiny-slider/tiny-slider.js' %}"></script>
    <script src="{% static 'assets/vendors/wnumb/wNumb.min.js' %}"></script>
    <script src="{% static 'assets/vendors/owl-carousel/js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'assets/vendors/wow/wow.js' %}"></script>
    <script src="{% static 'assets/vendors/imagesloaded/imagesloaded.min.js' %}"></script>
    <script src="{% static 'assets/vendors/isotope/isotope.js' %}"></script>
    <script src="{% static 'assets/vendors/countdown/countdown.min.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-circleType/jquery.circleType.js' %}"></script>
    <script src="{% static 'assets/vendors/jquery-lettering/jquery.lettering.min.js' %}"></script>
    <!-- template js -->
    <script src="{% static 'assets/js/grdeen.js' %}"></script>

    <!-- Notification System JavaScript -->
    <script src="{% static 'assets/js/notifications.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const likeButtons = document.querySelectorAll('.like_product');
            likeButtons.forEach(a => {
                const productId = a.getAttribute('data-id');
                fetch(`/api/user/${productId}/likes/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.liked);
                        if (data.liked) {
                            a.innerHTML = '<i class="fas fa-heart"></i>';
                        } else {
                            a.innerHTML = '<i class="icon-heart"></i>';
                        }
                    })
                    .catch(error => console.info('Error:', error));
            });
            likeButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const productId = this.getAttribute('data-id');
                    fetch(`/api/user/${productId}/like/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({}) // Body can be empty for this request
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Like API response:', data); // Debug log

                            // Heart ikonni yangilash
                            let heartIcon = '<i class="far fa-heart"></i>';

                            // Server dan kelgan message ga qarab harakat qilish
                            if (data.message === 'Mahsulot likega qo\'shildi!' || data.status === 'liked') {
                                // LIKE qo'shildi
                                heartIcon = '<i class="fas fa-heart" style="color: #1a9120;"></i>';
                                console.log(`‚úÖ LIKED: ${data.message}`);

                            } else if (data.message === 'Mahsulot likedan o\'chirildi!' || data.status === 'unliked') {
                                // LIKE o'chirildi
                                heartIcon = '<i class="far fa-heart"></i>';
                                console.log(`‚ùå UNLIKED: ${data.message}`);

                            } else if (data.status === 'error') {
                                // Xatolik holati
                                console.log(`üö´ ERROR: ${data.message}`);
                                showNotification(data.message || 'Xatolik yuz berdi!', 'error');
                                return; // Countni o'zgartirmaslik

                            } else {
                                // Noma'lum holat
                                console.log(`‚ö†Ô∏è UNKNOWN STATUS: ${data.status} | Message: ${data.message}`);
                                showNotification(data.message || 'Noma\'lum holat', 'warning');
                                return;
                            }

                            // Heart ikonni yangilash
                            this.innerHTML = heartIcon;

                            // Likes countni serverdan yangilash
                            updateLikesCount();

                        })
                        .catch(error => console.error('Error:', error));
                });
            });
        });

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cartButtons = document.querySelectorAll('.cart_api');
            cartButtons.forEach(a => {
                const productId = a.getAttribute('data-id');
                fetch(`/api/user/${productId}/cart/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (data.added) {
                            a.classList.add('cart-active');
                            a.innerHTML = '<i class="fas fa-shopping-cart"></i>';

                        } else {
                            // a.classList.remove('cart-active');

                            a.innerHTML = '<i class="fas fa-cart-plus"></i>';
                        }
                    })
                    .catch(error => console.info('Error:', error));
            });
            cartButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const productId = this.getAttribute('data-id');
                    fetch(`/api/user/${productId}/cart/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({}) // Body can be empty for this request
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status == 'added') {
                                this.classList.add('cart-active');
                                this.innerHTML = '<i class="fas fa-shopping-cart"></i>';
                                showNotification('Mahsulot savatga qo\'shildi!', 'success');
                                updateCartCount();
                            } else if (data.status == 'removed') {
                                this.classList.remove('cart-active');
                                this.innerHTML = '<i class="fas fa-cart-plus"></i>';
                                showNotification('Mahsulot savatdan o\'chirildi!', 'info');
                                updateCartCount();
                            } else {
                                this.classList.remove('cart-active');
                                this.innerHTML = '<i class="fas fa-cart-plus"></i>';
                                updateCartCount();
                            }
                        })
                        .catch(error => console.error('Error:', error));

                });
            });
        });
    </script>
    <script>
        // Buy Now button functionality
        document.addEventListener('DOMContentLoaded', function () {
            const buyNowButtons = document.querySelectorAll('.buy-now-btn');
            buyNowButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const productId = this.getAttribute('data-id');

                    // Add product to cart
                    fetch(`/api/user/${productId}/cart/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({})
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status == 'added' || data.status == 'removed') {
                                // Update cart count
                                updateCartCount();
                                // Redirect to cart page
                                window.location.href = "{% url 'cart' %}";
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Even on error, redirect to cart page
                            window.location.href = "{% url 'cart' %}";
                        });
                });
            });
        });
    </script>
    <script>

        function updateCartCount() {
            const cart_count = document.querySelector('#cart_count');

            fetch('/api/cart/count/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    // Faqat cart count elementlarini yangilash
                    if (cart_count) {
                        cart_count.textContent = data.cart_count;
                    }

                    // Boshqa cart count elementlarini ham yangilash
                    const allCartCounts = document.querySelectorAll('#cart_count');
                    allCartCounts.forEach(element => {
                        element.textContent = data.cart_count;
                    });
                })
                .catch(error => console.error('Error fetching cart count:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateCartCount();
        });
    </script>


    <script>
        // Log collector for debugging
        window.debugLogs = [];
        const originalConsoleLog = console.log;
        console.log = function (...args) {
            window.debugLogs.push({
                time: new Date().toLocaleTimeString(),
                message: args.join(' ')
            });
            originalConsoleLog.apply(console, args);
        };

        function updateLikesCount() {
            console.log('updateLikesCount called at:', new Date().toLocaleTimeString()); // Debug log

            // Barcha mumkin bo'lgan likes count elementlarini topish
            const likesCountSelectors = [
                '#likes_count',
                '.main-header__likes__count',
                '[class*="likes"][class*="count"]',
                'span[id*="likes"]',
                '*[data-likes-count]'
            ];

            let likesCountElements = [];
            likesCountSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (!likesCountElements.includes(el)) {
                        likesCountElements.push(el);
                    }
                });
            });

            console.log('Found likes count elements:', likesCountElements.length, likesCountElements); // Debug log

            fetch('/api/likes/count/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    console.log('Likes count API response status:', response.status); // Debug log
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Likes count API data:', data); // Debug log

                    // Foydalanuvchining o'z likes count ini olish
                    const displayCount = data.likes_count !== undefined ? data.likes_count : 0;

                    console.log('Display count will be:', displayCount); // Debug log

                    // Barcha likes count elementlarini yangilash
                    likesCountElements.forEach((element, index) => {
                        if (element) {
                            const oldValue = element.textContent;

                            // Bir necha usul bilan yangilash
                            element.textContent = displayCount;
                            element.innerHTML = displayCount;
                            element.innerText = displayCount;

                            // Attribute orqali ham yangilash
                            element.setAttribute('data-count', displayCount);

                            console.log(`Updated element ${index + 1} from "${oldValue}" to "${displayCount}"`); // Debug log

                            // Visual feedback effect
                            element.style.transition = 'all 0.4s ease';
                            element.style.backgroundColor = '#28a745';
                            element.style.color = 'white';
                            element.style.transform = 'scale(1.15)';
                            element.style.borderRadius = '50%';
                            element.style.boxShadow = '0 0 15px rgba(40, 167, 69, 0.6)';

                            // Reset styles after animation
                            setTimeout(() => {
                                element.style.backgroundColor = '';
                                element.style.color = '';
                                element.style.transform = '';
                                element.style.borderRadius = '';
                                element.style.boxShadow = '';
                            }, 800);

                            // Force DOM reflow
                            element.offsetHeight;
                        }
                    });

                    if (likesCountElements.length === 0) {
                        console.warn('‚ö†Ô∏è No likes count elements found! Searching all elements...'); // Debug log
                        // Barcha mumkin bo'lgan elementlarni qidirish
                        const allElements = document.querySelectorAll('*');
                        const possibleElements = Array.from(allElements).filter(el =>
                            el.id && el.id.toLowerCase().includes('like') ||
                            el.className && el.className.toLowerCase().includes('like') ||
                            el.textContent && /^\d+$/.test(el.textContent.trim())
                        );
                        console.log('Possible likes elements:', possibleElements);
                    }
                })
                .catch(error => {
                    console.error('Error fetching likes count:', error);
                });
        }

        // Debug function to show logs
        function showDebugLogs() {
            console.log('=== DEBUG LOGS ===');
            window.debugLogs.forEach((log, index) => {
                console.log(`${index + 1}. [${log.time}] ${log.message}`);
            });
            console.log('=== ELEMENT CHECK ===');
            console.log('likes_count element:', document.querySelector('#likes_count'));
            console.log('All like-related elements:', document.querySelectorAll('[id*="like"], [class*="like"]'));
        }

        // Automatic debug after 3 seconds
        setTimeout(() => {
            console.log('=== AUTOMATIC DEBUG AFTER PAGE LOAD ===');
            showDebugLogs();
        }, 3000);

        document.addEventListener('DOMContentLoaded', function () {
            updateLikesCount();
        });
    </script>

    <!-- CART MANAGEMENT API FUNCTIONS -->
    <script>
        // Cart management functions - miqdorni o'zgartirish, o'chirish va tozalash


        // Cart miqdorini yangilash
        function updateCartQuantity(cartId, quantity) {
            fetch(`/api/cart/update/${cartId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    quantity: quantity
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'updated') {
                        showNotification(data.message, 'success');

                        // Miqdor va narxni yangilash
                        updateCartItemDisplay(cartId, data.item_quantity, data.item_total);
                        updateCartCount();
                        updateCartTotals(data.cart_total_items, data.cart_total_price);

                    } else if (data.status === 'removed') {
                        showNotification(data.message, 'info');

                        // Item ni o'chirish
                        const cartItem = document.querySelector(`[data-cart-id="${cartId}"]`);
                        if (cartItem) {
                            cartItem.remove();
                        }

                        updateCartCount();
                        updateCartTotals(data.cart_total_items, data.cart_total_price);

                    } else if (data.status === 'unauthenticated') {
                        showNotification('Iltimos login qiling', 'warning');
                    } else {
                        showNotification('Xatolik yuz berdi', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Xatolik yuz berdi', 'error');
                });
        }

        // Cart miqdorini oshirish
        function increaseQuantity(cartId) {
            fetch(`/api/cart/increase/${cartId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'increased') {
                        showNotification(data.message, 'success');

                        // Miqdor va narxni yangilash
                        updateCartItemDisplay(cartId, data.item_quantity, data.item_total);
                        updateCartCount();
                        updateCartTotals(data.cart_total_items, data.cart_total_price);

                    } else if (data.status === 'unauthenticated') {
                        showNotification('Iltimos login qiling', 'warning');
                    } else {
                        showNotification('Xatolik yuz berdi', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Xatolik yuz berdi', 'error');
                });
        }

        // Cart miqdorini kamaytirish
        function decreaseQuantity(cartId) {
            // Joriy miqdorni tekshirish
            const qtyInput = document.getElementById(`qty-${cartId}`);
            if (qtyInput) {
                const currentQuantity = parseInt(qtyInput.value);
                if (currentQuantity <= 1) {
                    showNotification('Miqdor kamida 1 bo\'lishi kerak', 'warning');
                    return;
                }
            }

            fetch(`/api/cart/decrease/${cartId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'decreased') {
                        showNotification(data.message, 'success');

                        // Miqdor va narxni yangilash
                        updateCartItemDisplay(cartId, data.item_quantity, data.item_total);
                        updateCartCount();
                        updateCartTotals(data.cart_total_items, data.cart_total_price);

                    } else if (data.status === 'removed') {
                        showNotification(data.message, 'info');

                        // Item ni o'chirish
                        const cartItem = document.querySelector(`[data-cart-id="${cartId}"]`);
                        if (cartItem) {
                            cartItem.remove();
                        }

                        updateCartCount();
                        updateCartTotals(data.cart_total_items, data.cart_total_price);

                    } else if (data.status === 'unauthenticated') {
                        showNotification('Iltimos login qiling', 'warning');
                    } else {
                        showNotification('Xatolik yuz berdi', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Xatolik yuz berdi', 'error');
                });
        }

        // Barcha cart ni tozalash
        function clearCart() {
            if (!confirm('Barcha mahsulotlarni o\'chirishga ishonchingiz komilmi? Bu amalni bekor qilib bo\'lmaydi!')) {
                return;
            }

            fetch('/api/cart/clear/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'cleared') {
                        showNotification(data.message, 'success');

                        // Barcha cart itemlarni o'chirish
                        const cartItems = document.querySelectorAll('[data-cart-id]');
                        cartItems.forEach(item => item.remove());

                        // Cart count va totallarni yangilash
                        updateCartCount();
                        updateCartTotals(0, 0);

                        // Agar cart sahifasida bo'lsak, bo'sh holat ko'rsatish
                        if (window.location.pathname.includes('/cart')) {
                            showEmptyCartState();
                        }

                    } else if (data.status === 'empty') {
                        showNotification(data.message, 'info');
                    } else if (data.status === 'unauthenticated') {
                        showNotification('Iltimos login qiling', 'warning');
                    } else {
                        showNotification('Xatolik yuz berdi', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Xatolik yuz berdi', 'error');
                });
        }

        // Helper functions
        function updateQuantityButtons(cartId, quantity) {
            const decreaseBtn = document.querySelector(`button[onclick="decreaseQuantity(${cartId})"]`);

            if (decreaseBtn) {
                if (quantity <= 1) {
                    decreaseBtn.disabled = true;
                    decreaseBtn.style.opacity = '0.5';
                    decreaseBtn.style.cursor = 'not-allowed';
                    decreaseBtn.setAttribute('title', 'Miqdor kamida 1 bo\'lishi kerak');
                } else {
                    decreaseBtn.disabled = false;
                    decreaseBtn.style.opacity = '1';
                    decreaseBtn.style.cursor = 'pointer';
                    decreaseBtn.removeAttribute('title');
                }
            }
        }

        function updateCartItemDisplay(cartId, quantity, total) {
            // Miqdorni ko'rsatuvchi elementni yangilash
            const quantityElement = document.querySelector(`#quantity-${cartId}`);
            if (quantityElement) {
                quantityElement.textContent = quantity;
            }

            // Input maydoni bo'lsa
            const quantityInput = document.querySelector(`#qty-${cartId}`);
            if (quantityInput) {
                quantityInput.value = quantity;
            }

            // Jami narxni yangilash
            const totalElement = document.querySelector(`#total-${cartId}`);
            if (totalElement) {
                totalElement.textContent = `$${total.toFixed(2)}`;
            }

            // Quantity button holatini yangilash (agar updateQuantityButtons funksiyasi mavjud bo'lsa)
            if (typeof updateQuantityButtons === 'function') {
                updateQuantityButtons(cartId, quantity);
            }
        }

        function updateCartTotals(totalItems, totalPrice) {
            // Subtotal ni yangilash
            const subtotalElements = document.querySelectorAll('.cart-subtotal, #cartSubtotal, #subtotal');
            subtotalElements.forEach(element => {
                if (element) {
                    element.textContent = `$${totalPrice.toFixed(2)}`;
                }
            });

            // Total ni yangilash (shipping bilan birga)
            const shipping = 20;
            const finalTotal = totalPrice + shipping;
            const totalElements = document.querySelectorAll('#cartTotal, .cart-total, #total');
            totalElements.forEach(element => {
                if (element) {
                    element.innerHTML = `<strong>$${finalTotal.toFixed(2)}</strong>`;
                }
            });

            // Cart count ni yangilash - faqat cart count elementlarini tanlaymiz
            const cartCountElements = document.querySelectorAll('#cart_count, .cart-count');
            cartCountElements.forEach(element => {
                if (element && element.id !== 'likes_count') {
                    element.textContent = totalItems;
                }
            });
        }

        function showEmptyCartState() {
            const cartContainer = document.querySelector('#cartItemsContainer, .cart-items-container');
            if (cartContainer) {
                cartContainer.innerHTML = `
            <div class="empty-cart-message" style="text-align: center; padding: 50px;">
                <div class="empty-cart-icon" style="font-size: 64px; color: #ccc; margin-bottom: 20px;">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3>Savatingiz Bo'sh</h3>
                <p>Hali hech qanday mahsulot qo'shilmagan. Mahsulotlar sahifasiga o'ting va o'zingizga yoqqan narsalarni tanlang!</p>
                <a href="{% url 'products' %}" class="grdeen-btn" style="margin-top: 20px;">
                    <span><i class="fas fa-shopping-cart"></i> Hozir Xarid Qiling</span>
                </a>
            </div>
        `;
            }
        }

        // Notification function (agar mavjud bo'lmasa)
        function showNotification(message, type = 'info') {
            // Mavjud notification tizimidan foydalanish
            if (typeof createNotification === 'function') {
                createNotification(message, type);
            } else {
                // Oddiy alert
                console.log(`${type.toUpperCase()}: ${message}`);

                // Yoki oddiy toast yaratish
                const toast = document.createElement('div');
                toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 15px 20px;
            border-radius: 8px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
            color: white;
            font-weight: 500;
            min-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        `;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 3000);
            }
        }

        // Sahifa yuklanganda barcha quantity button holatini tekshirish
        document.addEventListener('DOMContentLoaded', function () {
            // Barcha quantity input'larni topish va tegishli button holatini o'rnatish
            const qtyInputs = document.querySelectorAll('[id^="qty-"]');
            qtyInputs.forEach(input => {
                const cartId = input.id.replace('qty-', '');
                const quantity = parseInt(input.value);
                updateQuantityButtons(cartId, quantity);
            });
        });
    </script>
    <!-- Custom Google Translate Script -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'uzb' }, 'google_translate_element');
        }

        // function hideGoogleTranslateBar() {
        //     var element = document.querySelector("#\\:1\\.container");
        //     if (element) {
        //         element.style.visibility = "hidden";
        //         element.style.opacity = "0";
        //     }
        // }

        // hideGoogleTranslateBar();
        function waitForElement(className, callback) {
            const observer = new MutationObserver(() => {
                const element = document.querySelector(`${className}`);
                if (element) {

                    element.style.visibility = "hidden";
                    element.style.opacity = "0";

                    observer.disconnect(); // kuzatishni to‚Äòxtatish
                    callback(element);
                }
            });

            observer.observe(document.body, { childList: true, subtree: true });
        }

        // Misol:sour
        waitForElement('#\\:1\\.container', (el) => {
            console.log('Div paydo bo‚Äòldi!', el);
            el.style.visibility = "hidden";
            el.style.opacity = "0";
        });


        function translateTo(language) {
            var selectField = document.querySelector("select.goog-te-combo");
            if (selectField) {
                selectField.value = language;
                selectField.dispatchEvent(new Event('change'));
                // setTimeout(hideGoogleTranslateBar, 100);
            }
        }
    </script>

    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <!-- CHAT WIDGET -->
    <style>
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
        }

        .chat-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a4d007 0%, #8fc400 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(164, 208, 7, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .chat-button:hover {
            transform: scale(1.05);
        }

        .chat-button svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
        }

        .chat-window.active {
            display: flex;
        }

        .chat-header {
            background: linear-gradient(135deg, #a4d007 0%, #8fc400 100%);
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 16px;
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .chat-body {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-right: 5px;
        }

        #welcomeScreen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 75%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .message.user .message-content {
            background: #a4d007;
            color: white;
        }

        .message.bot .message-content,
        .message.admin .message-content {
            background: white;
            color: #495057;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 14px;
        }

        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #a4d007;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .welcome-form {
            padding: 20px;
        }

        .welcome-form h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .welcome-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .welcome-form button {
            width: 100%;
            padding: 12px;
            background: #a4d007;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .phone-input-container {
            display: flex;
            gap: 0;
            margin-bottom: 10px;
        }

        .country-select {
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            min-width: 100px;
            outline: none;
        }

        .country-select:focus {
            border-color: #a4d007;
            box-shadow: 0 0 0 2px rgba(164, 208, 7, 0.2);
        }

        .phone-input-container #userPhone {
            flex: 1;
            margin-bottom: 0;
            border-radius: 0 8px 8px 0;
            border-left: none;
        }

        .phone-input-container #userPhone:focus {
            border-color: #a4d007;
            box-shadow: 0 0 0 2px rgba(164, 208, 7, 0.2);
        }
    </style>

    <div class="chat-widget" id="chatWidget">
        <button class="chat-button" id="chatButton" onclick="toggleChat()">
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
            </svg>
        </button>

        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <h3>Chat Support</h3>
                <button class="close-button" onclick="toggleChat()">&times;</button>
            </div>

            <div class="chat-body" id="chatBody">
                <div id="welcomeScreen">
                    <div class="welcome-form">
                        <h3>Sizga qanday yordam bera olamiz?</h3>
                        <input type="text" id="userName" placeholder="Ismingiz" required>
                        <div class="phone-input-container">
                            <select id="countryCode" class="country-select">
                                <option value="+998" data-flag="üá∫üáø">üá∫üáø +998</option>
                                <option value="+1" data-flag="üá∫üá∏">üá∫üá∏ +1</option>
                                <option value="+7" data-flag="üá∑üá∫">üá∑üá∫ +7</option>
                                <option value="+44" data-flag="üá¨üáß">üá¨üáß +44</option>
                                <option value="+49" data-flag="üá©üá™">üá©üá™ +49</option>
                                <option value="+33" data-flag="üá´üá∑">üá´üá∑ +33</option>
                                <option value="+39" data-flag="üáÆüáπ">üáÆüáπ +39</option>
                                <option value="+34" data-flag="üá™üá∏">üá™üá∏ +34</option>
                                <option value="+86" data-flag="üá®üá≥">üá®üá≥ +86</option>
                                <option value="+81" data-flag="üáØüáµ">üáØüáµ +81</option>
                                <option value="+82" data-flag="üá∞üá∑">üá∞üá∑ +82</option>
                                <option value="+91" data-flag="üáÆüá≥">üáÆüá≥ +91</option>
                                <option value="+90" data-flag="üáπüá∑">üáπüá∑ +90</option>
                                <option value="+971" data-flag="üá¶üá™">üá¶üá™ +971</option>
                                <option value="+966" data-flag="üá∏üá¶">üá∏üá¶ +966</option>
                            </select>
                            <input type="tel" id="userPhone" placeholder="Telefon raqamingiz" required>
                        </div>
                        <button onclick="startChat()">Chatni boshlash</button>
                    </div>
                </div>
                <div id="chatMessages" style="display: none;"></div>
            </div>

            <div class="chat-input-area" id="chatInputArea" style="display: none;">
                <form class="chat-input-form" onsubmit="sendMessage(event)">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Xabar yozing..." required>
                    <button type="submit" class="send-button">
                        <svg viewBox="0 0 24 24">
                            <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let chatSessionToken = null;
        let messagePollingInterval = null;

        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('active');

            if (chatWindow.classList.contains('active') && chatSessionToken) {
                loadMessages().then(() => {
                    setTimeout(scrollToBottom, 200);
                });
                startMessagePolling();
            } else {
                stopMessagePolling();
            }
        }

        async function startChat() {
            const name = document.getElementById('userName').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const countryCode = document.getElementById('countryCode').value;

            if (!name || !phone) {
                alert('Iltimos, ism va telefon raqamingizni kiriting');
                return;
            }

            // Telefon raqamini formatlash
            const formattedPhone = formatPhoneNumber(countryCode, phone);

            if (!validatePhoneNumber(formattedPhone)) {
                alert('Iltimos, to\'g\'ri telefon raqami kiriting');
                return;
            }

            try {
                const response = await fetch('/api/chat/init/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, phone: formattedPhone })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    chatSessionToken = data.session_token;
                    localStorage.setItem('chatSessionToken', chatSessionToken);

                    document.getElementById('welcomeScreen').style.display = 'none';
                    document.getElementById('chatMessages').style.display = 'block';
                    document.getElementById('chatInputArea').style.display = 'block';

                    // Birinchi xabar foydalanuvchidan kutiladi
                    startMessagePolling();
                } else {
                    alert('Xatolik yuz berdi. Qayta urinib ko\'ring.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Xatolik yuz berdi');
            }
        }

        async function sendMessage(event) {
            event.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || !chatSessionToken) return;

            // UI ga darhol qo'shish
            addMessage('user', message);
            messageInput.value = '';

            try {
                const response = await fetch('/api/chat/send/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_token: chatSessionToken,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.auto_response) {
                    setTimeout(() => {
                        addMessage('bot', data.auto_response);
                    }, 500);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
        }

        function addMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${text}</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        async function loadMessages() {
            if (!chatSessionToken) return;

            try {
                const response = await fetch(`/api/chat/messages/${chatSessionToken}/`);
                const data = await response.json();

                if (data.status === 'success') {
                    const chatMessages = document.getElementById('chatMessages');
                    const currentScrollPosition = chatMessages.scrollTop;
                    const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 100;

                    chatMessages.innerHTML = '';

                    data.messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${msg.sender}`;
                        messageDiv.innerHTML = `
                            <div class="message-content">
                                <div class="message-text">${msg.message}</div>
                            </div>
                        `;
                        chatMessages.appendChild(messageDiv);
                    });

                    // Faqat foydalanuvchi pastda turgan bo'lsa scroll qilish
                    // yoki yangi xabar kelgan bo'lsa
                    if (isAtBottom || data.messages.length > 0) {
                        scrollToBottom();
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function startMessagePolling() {
            stopMessagePolling();
            messagePollingInterval = setInterval(loadMessages, 5000); // Har 5 sekundda yangilash
        }

        function stopMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
        }

        // Telefon raqamini formatlash funksiyasi
        function formatPhoneNumber(countryCode, phone) {
            // Faqat raqamlarni qoldirish
            let cleanPhone = phone.replace(/\D/g, '');

            // Agar telefon raqami country code bilan boshlansa, uni olib tashlash
            const codeWithoutPlus = countryCode.replace('+', '');
            if (cleanPhone.startsWith(codeWithoutPlus)) {
                cleanPhone = cleanPhone.substring(codeWithoutPlus.length);
            }

            return countryCode + cleanPhone;
        }

        // Telefon raqamini tekshirish funksiyasi
        function validatePhoneNumber(phone) {
            // Asosiy tekshiruv - kamida 7 ta raqam bo'lishi kerak
            const phoneRegex = /^\+\d{1,4}\d{7,15}$/;
            return phoneRegex.test(phone);
        }

        // Telefon input uchun formatlash
        function setupPhoneInput() {
            const phoneInput = document.getElementById('userPhone');
            const countrySelect = document.getElementById('countryCode');

            if (phoneInput) {
                phoneInput.addEventListener('input', function (e) {
                    let value = e.target.value;
                    // Faqat raqamlarni qoldirish
                    value = value.replace(/\D/g, '');

                    // Formatni qo'llash - 3-2-2 yoki 2-3-2-2 format
                    const countryCode = countrySelect.value;
                    let formattedValue = '';

                    if (countryCode === '+998') {
                        // O'zbekiston formati: 12 345 67 89
                        if (value.length <= 2) {
                            formattedValue = value;
                        } else if (value.length <= 5) {
                            formattedValue = value.slice(0, 2) + ' ' + value.slice(2);
                        } else if (value.length <= 7) {
                            formattedValue = value.slice(0, 2) + ' ' + value.slice(2, 5) + ' ' + value.slice(5);
                        } else if (value.length <= 9) {
                            formattedValue = value.slice(0, 2) + ' ' + value.slice(2, 5) + ' ' + value.slice(5, 7) + ' ' + value.slice(7);
                        } else {
                            formattedValue = value.slice(0, 2) + ' ' + value.slice(2, 5) + ' ' + value.slice(5, 7) + ' ' + value.slice(7, 9);
                        }
                    } else if (countryCode === '+1') {
                        // AQSH formati: 123 456 7890
                        if (value.length <= 3) {
                            formattedValue = value;
                        } else if (value.length <= 6) {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3);
                        } else {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 10);
                        }
                    } else if (countryCode === '+7') {
                        // Rossiya formati: 123 456 78 90
                        if (value.length <= 3) {
                            formattedValue = value;
                        } else if (value.length <= 6) {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3);
                        } else if (value.length <= 8) {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
                        } else {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 8) + ' ' + value.slice(8, 10);
                        }
                    } else {
                        // Umumiy format: 123 456 789
                        if (value.length <= 3) {
                            formattedValue = value;
                        } else if (value.length <= 6) {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3);
                        } else {
                            formattedValue = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
                        }
                    }

                    e.target.value = formattedValue;
                });

                phoneInput.addEventListener('blur', function (e) {
                    const countryCode = countrySelect.value;
                    const phone = e.target.value.trim();
                    if (phone) {
                        const formatted = formatPhoneNumber(countryCode, phone);
                        console.log('Formatted phone:', formatted);
                    }
                });

                // Country code o'zgarganda formatni yangilash
                countrySelect.addEventListener('change', function () {
                    if (phoneInput.value) {
                        // Joriy qiymatni tozalash va qayta formatlash
                        const cleanValue = phoneInput.value.replace(/\D/g, '');
                        phoneInput.value = cleanValue;
                        // Input eventini trigger qilish
                        phoneInput.dispatchEvent(new Event('input'));
                    }
                });
            }
        }

        // Sahifa yuklanganda eski sessiyani tekshirish
        window.addEventListener('DOMContentLoaded', function () {
            setupPhoneInput();
            const savedToken = localStorage.getItem('chatSessionToken');
            if (savedToken) {
                chatSessionToken = savedToken;
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('chatMessages').style.display = 'block';
                document.getElementById('chatInputArea').style.display = 'block';
                loadMessages().then(() => {
                    scrollToBottom();
                });
            }
        });

        // Til almashtirish funksiyasi
        function setLang(lang) {
            document.getElementById('lang-input').value = lang;
            document.getElementById('lang-form').submit();
        }
    </script>
</body>

</html>